#!/bin/bash

echo "GALAXY WINDOWS SCRIPT"
pwd
GALAXY42_DIR=$(pwd)/galaxy42

## clone and build boost
git clone https://github.com/boostorg/boost.git
cd boost
BOOST_DIR=$(pwd)
git checkout boost-1.61.0
git submodule update --init --recursive --depth 1
echo "using gcc : 4.9.2 : /usr/bin/x86_64-w64-mingw32-g++ ;" > user-config.jam  
./bootstrap.sh --without-icu
mkdir mingw_build
./b2 -a --user-config=user-config.jam toolset=gcc target-os=windows variant=release \
 --prefix=/"$BOOST_DIR"/mingw_build threading=multi  threadapi=win32 link=shared \
 runtime-link=shared -j 2  --with-filesystem --with-system --with-program_options \
-sNO_BZIP2=1 --sNO_ZLIB=1 --layout=tagged install

# copy boost includes
for D in `find ./libs -maxdepth 1 -type d`; do
	cp -rv "$D"/include ./mingw_build
done

cd ..

## clone and build libsodium
git clone https://github.com/jedisct1/libsodium.git
cd libsodium
SODIUM_DIR=$(pwd)
git checkout 1.0.11
export CC=x86_64-w64-mingw32-gcc
./autogen.sh
sed -i "s/make check && //" dist-build/msys2-win64.sh
./dist-build/msys2-win64.sh


## Cross building galaxy42
cd "$GALAXY42_DIR"
cmake -DBOOST_ROOT=/"$BOOST_DIR"/mingw_build -DSODIUM_ROOT_DIR=/"$SODIUM_DIR"/libsodium-win64 -DTARGET_ARCH=x86_64-w64-mingw32 -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake.in -DCMAKE_BUILD_TYPE=Debug .
make tunserver.elf

sha512sum tunserver.elf.exe
