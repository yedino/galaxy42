# For creating tun
sudo: required

# Enable C++ support
language: cpp
    
os: 
  - linux
  - osx

dist: trusty
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-5
      - g++-5
      - libboost-all-dev
      - libfftw3-dev

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo add-apt-repository ppa:chris-lea/libsodium -y  ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get update -q                              ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get install libsodium-dev -y               ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then pip install --user cpp-coveralls                    ; fi
  
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update               ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install autoconf     ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew unlink pkg-config   ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install pkg-config   ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install cmake        ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install boost        ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install libsodium    ; fi

install:
  - if [[ "$CXX" == "g++" ]]; then export CXX="g++-5" CC="gcc-5"  ; fi

env:
  global:
    - COVERAGE=0
    - EXTLEVEL=0
  matrix:
    - EXTLEVEL=30
    - EXTLEVEL=20
    - EXTLEVEL=10

matrix:
    fast_finish: true

    include:
      - os: linux
        env: COVERAGE=1 EXTLEVEL=0
        compiler: gcc

      - os: osx
        osx_image: xcode7.3
        env: EXTLEVEL=0
        compiler: clang

    allow_failures:
      - os: osx
      - env: EXTLEVEL=30
      - env: EXTLEVEL=20
      - env: EXTLEVEL=10


# Adding setcap for tunserver.elf etc.
before_script:
  - cd ${TRAVIS_BUILD_DIR} # back to main dir 
  - cd share/script/install-as-root/ && sudo ./install -y

script:
  - cd ${TRAVIS_BUILD_DIR}
  - ./do --go

after_success:
  - ./test-release.elf    # run gtests
  - if [[ "$COVERAGE" == "1" ]]; then coveralls -e src/test -e build_extra -e depends --gcov-options '\-lp' --gcov 'gcov-5' ; fi

#notifications:
#  irc:
#    on_success: change
#    on_failure: change
#    channels:
#      - "icann.irc.meshnet.pl#antinet-dev"
#    template:
#      - "%{repository}#%{build_number} (%{branch} - %{commit} : %{author}): %{message}"
#      - "Change view : %{compare_url}"
#      - "Build details : %{build_url}"
  #email:
  #  to minimize spam
  #  on_success: change
  #  on_failure: always
  #recipients:
  #  - one@example.com
  #  - other@example.com


