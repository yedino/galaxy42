# dependences
sudo aptitude install git ruby sudo apt-cacher-ng qemu-utils debootstrap lxc python-cheetah parted kpartx bridge-utils make ubuntu-archive-keyring curl

# suite (ubuntu 16.04) xenial in gitian is not documented, but it works for us.
https://github.com/devrandom/gitian-builder.git
cd gitian-builder

bin/make-base-vm --lxc --arch amd64 --suite xenial

PATH=$PATH:$(pwd)/libexec
export USE_LXC=1


script {
	# the version of lxc-start in Debian needs to run as root, so make sure
	# that the build script can execute it without providing a password
	echo "%sudo ALL=NOPASSWD: /usr/bin/lxc-start" > /etc/sudoers.d/gitian-lxc
	echo "%sudo ALL=NOPASSWD: /usr/bin/lxc-execute" >> /etc/sudoers.d/gitian-lxc

	# make /etc/rc.local script that sets up bridge between guest and host
	echo '#!/bin/sh -e' > /etc/rc.local
	echo 'brctl addbr br0' >> /etc/rc.local
	echo 'ifconfig br0 10.0.3.2/24 up' >> /etc/rc.local
	echo 'iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE' >> /etc/rc.local
	echo 'echo 1 > /proc/sys/net/ipv4/ip_forward' >> /etc/rc.local
	echo 'exit 0' >> /etc/rc.local
}

/etc/rc.local {
	#!/bin/sh -e
	brctl addbr br0
	ifconfig br0 10.0.3.2/24 up
	iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
	echo 1 > /proc/sys/net/ipv4/ip_forward
	exit 0
}

# make sure that USE_LXC is always set when logging in as debian,
# and configure LXC IP addresses
echo 'export USE_LXC=1' >> /home/debian/.profile
echo 'export GITIAN_HOST_IP=10.0.3.2' >> /home/debian/.profile
echo 'export LXC_GUEST_IP=10.0.3.5' >> /home/debian/.profile

#necessary? {
	ubuntu:
	echo '10.0.3.5 gitian' >> /etc/hosts
}

# sudo is necessary because of install-as-root script
path/to/gitian-builder/bin/gbuild --allow-sudo path/to/galaxy42/contrib/galaxy-linux.yml
